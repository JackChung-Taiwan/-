<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è‹±èªç™¼éŸ³å†’éšªï½œ2D å·è»¸éŠæˆ²</title>
<style>
:root{
  --ink:#0f172a;
  --paper:#ffffff;
  --accent:#3b82f6;
  --accent-2:#22c55e;
  --accent-3:#f97316;
  --danger:#ef4444;
  --shadow:#0f172a;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  min-height:100vh;
  font-family:"PingFang TC","Microsoft JhengHei",system-ui,sans-serif;
  background:linear-gradient(135deg,#e0f2fe 0%,#fef9c3 60%,#fde68a 100%);
  color:var(--ink);
}
.app{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  gap:16px;
  padding:16px;
}
.header{
  background:var(--paper);
  border:4px solid var(--ink);
  border-radius:18px;
  padding:16px;
  box-shadow:6px 6px 0 var(--shadow);
  display:flex;
  flex-direction:column;
  gap:12px;
}
.header-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
.title{
  font-size:26px;
  font-weight:900;
}
.subtitle{
  font-size:16px;
  font-weight:700;
  color:#334155;
}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.btn{
  background:var(--paper);
  border:3px solid var(--ink);
  border-radius:12px;
  padding:10px 16px;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
  box-shadow:4px 4px 0 var(--shadow);
}
.btn:active{ transform:translate(2px,2px); box-shadow:0 0 0 var(--shadow); }
.btn.primary{ background:var(--accent); color:#fff; }
.btn.success{ background:var(--accent-2); color:#fff; }
.btn.warn{ background:var(--accent-3); color:#fff; }
.pill{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border:3px solid var(--ink);
  border-radius:999px;
  background:var(--paper);
  font-weight:800;
}
.pill select{
  border:2px solid var(--ink);
  border-radius:8px;
  padding:4px 8px;
  font-weight:800;
}
.status-bar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.status-chip{
  background:#0f172a;
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  font-weight:800;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
}
.game-area{
  flex:1;
  min-height:0;
  background:var(--paper);
  border:4px solid var(--ink);
  border-radius:20px;
  box-shadow:6px 6px 0 var(--shadow);
  overflow:hidden;
  position:relative;
}
.scene{
  position:absolute;
  inset:0;
  overflow:hidden;
}
.layer{
  position:absolute;
  inset:0;
  background-repeat:repeat-x;
  animation:scroll 20s linear infinite;
}
.layer.sky{ background:linear-gradient(#bae6fd,#e0f2fe); animation-duration:60s; }
.layer.clouds{ background-image:radial-gradient(circle at 20% 30%,#fff 0 30px,transparent 31px),
                                radial-gradient(circle at 60% 20%,#fff 0 40px,transparent 41px),
                                radial-gradient(circle at 80% 35%,#fff 0 26px,transparent 27px);
  background-size:400px 200px;
  opacity:0.8;
  animation-duration:40s;
}
.layer.hills{ background:linear-gradient(#86efac 70%,transparent 70%),
                          radial-gradient(circle at 10% 100%,#22c55e 0 180px,transparent 181px),
                          radial-gradient(circle at 50% 100%,#4ade80 0 220px,transparent 221px),
                          radial-gradient(circle at 90% 100%,#16a34a 0 160px,transparent 161px);
  background-position:0 40%,0 100%,0 100%,0 100%;
  background-size:100% 100%;
  animation-duration:30s;
  opacity:0.85;
}
.layer.city{ background:linear-gradient(to top,#0f172a 0 30%,transparent 30%),
                           repeating-linear-gradient(to right,#0f172a 0 40px,transparent 40px 70px);
  background-size:300px 120px;
  background-position:0 65%;
  animation-duration:22s;
  opacity:0.6;
}
.layer.ground{
  background:linear-gradient(#a16207,#92400e);
  height:30%;
  top:auto;
  bottom:0;
  animation-duration:10s;
}
@keyframes scroll{
  from{ background-position-x:0; }
  to{ background-position-x:-1200px; }
}
.track{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:space-evenly;
  padding:60px 60px 80px 140px;
  pointer-events:none;
}
.lane{
  height:74px;
  border:2px dashed rgba(15,23,42,0.35);
  border-radius:999px;
  position:relative;
}
.runner{
  width:80px;
  height:80px;
  background:var(--accent);
  border:4px solid var(--ink);
  border-radius:16px;
  box-shadow:4px 4px 0 var(--shadow);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  position:absolute;
  left:40px;
  transition:top 0.25s ease;
  z-index:5;
}
.runner.jump{ animation:jump 0.6s ease; }
@keyframes jump{ 0%{ transform:translateY(0); } 50%{ transform:translateY(-24px); } 100%{ transform:translateY(0); } }
.token{
  position:absolute;
  min-width:140px;
  padding:10px 14px;
  background:#fff;
  border:3px solid var(--ink);
  border-radius:14px;
  font-weight:900;
  font-size:18px;
  box-shadow:4px 4px 0 var(--shadow);
  pointer-events:auto;
  cursor:pointer;
  transition:transform 0.2s ease;
}
.token:hover{ transform:scale(1.05); }
.token.correct{ background:var(--accent-2); color:#fff; }
.token.wrong{ background:var(--danger); color:#fff; }
.hud{
  position:absolute;
  top:16px;
  left:16px;
  right:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  z-index:6;
}
.hud-card{
  background:rgba(255,255,255,0.92);
  border:3px solid var(--ink);
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  box-shadow:4px 4px 0 var(--shadow);
}
.hud-card small{ display:block; font-size:12px; color:#475569; }
.feedback{
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  border:3px solid var(--ink);
  border-radius:999px;
  padding:10px 18px;
  font-weight:900;
  box-shadow:4px 4px 0 var(--shadow);
  display:none;
  z-index:10;
}
.feedback.show{ display:inline-flex; }
.panel{
  background:var(--paper);
  border:4px solid var(--ink);
  border-radius:18px;
  padding:14px;
  box-shadow:6px 6px 0 var(--shadow);
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
.controls-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.modal{
  width:min(640px, calc(100vw - 32px));
  background:#fff;
  border:4px solid var(--ink);
  border-radius:18px;
  padding:20px;
  box-shadow:6px 6px 0 var(--shadow);
}
.modal textarea{
  width:100%;
  height:180px;
  border:3px solid var(--ink);
  border-radius:12px;
  padding:12px;
  font-size:16px;
  font-weight:700;
}
.modal h2{ margin-top:0; }
.modal .tip{
  background:#f8fafc;
  border:2px dashed var(--ink);
  border-radius:12px;
  padding:10px;
  font-size:14px;
  font-weight:800;
  color:#475569;
}
@media (max-width: 900px){
  .track{ padding:80px 20px 80px 120px; }
  .token{ min-width:110px; font-size:16px; }
}
</style>
</head>
<body>
<div class="app">
  <section class="header">
    <div class="header-row">
      <div>
        <div class="title">è‹±èªç™¼éŸ³å†’éšªï½œ2D å·è»¸éŠæˆ²</div>
        <div class="subtitle">è½ç™¼éŸ³ã€è·‘æ­¥æ”¶é›†æ­£ç¢ºå–®å­—ï¼Œé‚„èƒ½è‡ªè¨‚é¡Œåº«ï¼</div>
      </div>
      <div class="status-bar">
        <div class="status-chip" id="scoreChip">Score 0</div>
        <div class="status-chip" id="roundChip">Round 1 / 6</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn primary" id="btnStart">é–‹å§‹éŠæˆ²</button>
      <button class="btn" id="btnSpeak">æ’­æ”¾ç™¼éŸ³</button>
      <button class="btn warn" id="btnBank">é¡Œåº«è¨­å®š</button>
      <div class="pill">
        <span>å›åˆ</span>
        <select id="roundSelect"></select>
      </div>
      <div class="pill">
        <span>é€Ÿåº¦</span>
        <select id="speedSelect">
          <option value="1">æ…¢é€Ÿ</option>
          <option value="1.3" selected>ä¸€èˆ¬</option>
          <option value="1.6">å¿«é€Ÿ</option>
        </select>
      </div>
    </div>
  </section>

  <section class="game-area">
    <div class="scene">
      <div class="layer sky"></div>
      <div class="layer clouds"></div>
      <div class="layer hills"></div>
      <div class="layer city"></div>
      <div class="layer ground"></div>
      <div class="track" id="track">
        <div class="lane" data-lane="0"></div>
        <div class="lane" data-lane="1"></div>
        <div class="lane" data-lane="2"></div>
      </div>
      <div class="runner" id="runner">ğŸƒ</div>
      <div class="hud">
        <div class="hud-card" id="targetCard">
          <small>æœ¬å›åˆç›®æ¨™</small>
          <div id="targetWord">Apple</div>
        </div>
        <div class="hud-card" id="hintCard">
          <small>ç™¼éŸ³æç¤º</small>
          <div id="targetHint">/ËˆÃ¦p.É™l/</div>
        </div>
      </div>
      <div class="feedback" id="feedback"></div>
    </div>
  </section>

  <section class="panel">
    <div class="controls-row">
      <button class="btn" id="btnUp">â¬†ï¸ ä¸Šä¸€è»Œé“</button>
      <button class="btn" id="btnDown">â¬‡ï¸ ä¸‹ä¸€è»Œé“</button>
      <button class="btn success" id="btnJump">è·³èº</button>
    </div>
    <div class="controls-row">
      <div class="pill">æ–¹å‘éµ â†‘ â†“ å¯ç§»å‹•è»Œé“</div>
      <div class="pill">ç©ºç™½éµ è·³èº</div>
    </div>
  </section>
</div>

<div class="overlay" id="bankOverlay">
  <div class="modal">
    <h2>è‡ªè¨‚é¡Œåº«</h2>
    <p class="tip">æ¯è¡Œä¸€çµ„ï¼šå–®å­— | ç™¼éŸ³æç¤ºã€‚ä¾‹ï¼šApple | /ËˆÃ¦p.É™l/ã€‚åªè¼¸å…¥å–®å­—ä¹Ÿå¯ä»¥ï¼Œç³»çµ±æœƒè‡ªå‹•å”¸è®€ã€‚</p>
    <textarea id="bankInput"></textarea>
    <div class="controls" style="margin-top:12px;">
      <button class="btn primary" id="btnSaveBank">å„²å­˜é¡Œåº«</button>
      <button class="btn" id="btnCloseBank">é—œé–‰</button>
    </div>
  </div>
</div>

<div class="overlay" id="resultOverlay">
  <div class="modal">
    <h2>ğŸ‰ å†’éšªçµæŸï¼</h2>
    <div class="tip" id="resultText">ä½ çš„å¾—åˆ†æ˜¯ 0 åˆ†ã€‚</div>
    <div class="controls" style="margin-top:12px;">
      <button class="btn success" id="btnRestart">å†æŒ‘æˆ°ä¸€æ¬¡</button>
      <button class="btn" id="btnCloseResult">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
const DEFAULT_BANK = [
  { word:"Apple", hint:"/ËˆÃ¦p.É™l/" },
  { word:"Banana", hint:"/bÉ™ËˆnÉ‘Ë.nÉ™/" },
  { word:"Orange", hint:"/ËˆÉ’r.ÉªndÊ’/" },
  { word:"Forest", hint:"/ËˆfÉ’r.Éªst/" },
  { word:"Ocean", hint:"/ËˆÉ™ÊŠ.ÊƒÉ™n/" },
  { word:"Rocket", hint:"/ËˆrÉ’k.Éªt/" },
  { word:"Rainbow", hint:"/ËˆreÉªn.bÉ™ÊŠ/" },
  { word:"Mountain", hint:"/ËˆmaÊŠn.tÉªn/" },
  { word:"Guitar", hint:"/É¡ÉªËˆtÉ‘Ër/" },
  { word:"Castle", hint:"/ËˆkÉ‘Ë.sÉ™l/" }
];

const track = document.getElementById("track");
const runner = document.getElementById("runner");
const targetWordEl = document.getElementById("targetWord");
const targetHintEl = document.getElementById("targetHint");
const scoreChip = document.getElementById("scoreChip");
const roundChip = document.getElementById("roundChip");
const feedback = document.getElementById("feedback");

const bankOverlay = document.getElementById("bankOverlay");
const bankInput = document.getElementById("bankInput");
const resultOverlay = document.getElementById("resultOverlay");
const resultText = document.getElementById("resultText");

const roundSelect = document.getElementById("roundSelect");
const speedSelect = document.getElementById("speedSelect");

let questionBank = [...DEFAULT_BANK];
let rounds = 6;
let speedFactor = 1.3;
let score = 0;
let currentRound = 0;
let currentQuestion = null;
let tokens = [];
let running = false;
let playerLane = 1;
let animationId = null;

function populateRounds(){
  for(let i=4;i<=12;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i} å›åˆ`;
    if(i === rounds) opt.selected = true;
    roundSelect.appendChild(opt);
  }
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function speak(text){
  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";
  utter.rate = 0.92;
  window.speechSynthesis.speak(utter);
}

function setRunnerLane(){
  const lanes = Array.from(track.querySelectorAll(".lane"));
  const lane = lanes[playerLane];
  if(!lane) return;
  const laneRect = lane.getBoundingClientRect();
  const trackRect = track.getBoundingClientRect();
  const top = laneRect.top - trackRect.top + (laneRect.height/2) - 40;
  runner.style.top = `${top}px`;
}

function showFeedback(message, success){
  feedback.textContent = message;
  feedback.style.background = success ? "#dcfce7" : "#fee2e2";
  feedback.classList.add("show");
  setTimeout(()=> feedback.classList.remove("show"), 1200);
}

function updateHud(){
  scoreChip.textContent = `Score ${score}`;
  roundChip.textContent = `Round ${currentRound} / ${rounds}`;
  if(currentQuestion){
    targetWordEl.textContent = currentQuestion.word;
    targetHintEl.textContent = currentQuestion.hint || "-";
  }
}

function pickQuestion(){
  if(questionBank.length < 3){
    alert("é¡Œåº«è‡³å°‘éœ€è¦ 3 å€‹å–®å­—");
    return null;
  }
  const answer = questionBank[Math.floor(Math.random()*questionBank.length)];
  const pool = questionBank.filter(item => item.word.toLowerCase() !== answer.word.toLowerCase());
  shuffle(pool);
  const distractors = pool.slice(0,2);
  const options = shuffle([answer, ...distractors]);
  return { answer, options };
}

function clearTokens(){
  tokens.forEach(token => token.el.remove());
  tokens = [];
}

function spawnTokens(){
  clearTokens();
  const question = pickQuestion();
  if(!question) return false;
  currentQuestion = question.answer;
  updateHud();
  speak(currentQuestion.word);

  const lanes = [0,1,2];
  shuffle(lanes);
  question.options.forEach((item, index)=>{
    const lane = lanes[index % lanes.length];
    const token = document.createElement("div");
    token.className = "token";
    token.textContent = item.word;
    token.dataset.word = item.word;
    token.dataset.correct = item.word.toLowerCase() === question.answer.word.toLowerCase();
    token.dataset.lane = String(lane);
    token.dataset.x = String(900 + index * 180);
    token.style.top = "0";
    token.style.left = "0";
    token.addEventListener("click", ()=> handleTokenClick(token));
    track.appendChild(token);

    tokens.push({
      el: token,
      lane,
      x: 900 + index * 180,
      resolved: false,
      isCorrect: token.dataset.correct === "true"
    });
  });
  return true;
}

function positionTokens(){
  const lanes = Array.from(track.querySelectorAll(".lane"));
  tokens.forEach(token => {
    const laneEl = lanes[token.lane];
    if(!laneEl) return;
    const laneRect = laneEl.getBoundingClientRect();
    const trackRect = track.getBoundingClientRect();
    const top = laneRect.top - trackRect.top + (laneRect.height/2) - 26;
    token.el.style.transform = `translate(${token.x}px, ${top}px)`;
  });
}

function handleTokenClick(tokenEl){
  if(!running) return;
  const word = tokenEl.dataset.word || "";
  const isCorrect = tokenEl.dataset.correct === "true";
  if(isCorrect){
    tokenEl.classList.add("correct");
    score += 10;
    showFeedback("ç­”å°äº†ï¼+10", true);
    speak(word);
    advanceRound();
  }else{
    tokenEl.classList.add("wrong");
    showFeedback("å†è½ä¸€æ¬¡ï¼", false);
    speak(currentQuestion.word);
  }
}

function advanceRound(){
  running = false;
  clearTokens();
  if(currentRound >= rounds){
    endGame();
    return;
  }
  setTimeout(()=>{
    currentRound += 1;
    updateHud();
    spawnTokens();
    running = true;
  }, 600);
}

function updateTokens(){
  const speed = 2.4 * speedFactor;
  tokens.forEach(token => {
    if(token.resolved) return;
    token.x -= speed;
    if(token.x < 0){
      token.resolved = true;
      if(token.isCorrect){
        showFeedback("éŒ¯éæ­£ç¢ºå–®å­—ï¼", false);
        advanceRound();
      }
    }
  });
}

function checkRunnerCollision(){
  const runnerRect = runner.getBoundingClientRect();
  tokens.forEach(token => {
    if(token.resolved) return;
    const tokenRect = token.el.getBoundingClientRect();
    const laneMatch = token.lane === playerLane;
    if(laneMatch && tokenRect.left < runnerRect.right && tokenRect.right > runnerRect.left){
      token.resolved = true;
      if(token.isCorrect){
        token.el.classList.add("correct");
        score += 12;
        showFeedback("è·‘æ­¥æ”¶é›†æˆåŠŸï¼+12", true);
        speak(currentQuestion.word);
        advanceRound();
      }else{
        token.el.classList.add("wrong");
        showFeedback("æ”¶é›†éŒ¯èª¤å–®å­—", false);
        speak(currentQuestion.word);
      }
    }
  });
}

function gameLoop(){
  if(!running){
    animationId = requestAnimationFrame(gameLoop);
    return;
  }
  updateTokens();
  positionTokens();
  checkRunnerCollision();
  animationId = requestAnimationFrame(gameLoop);
}

function startGame(){
  score = 0;
  currentRound = 1;
  updateHud();
  spawnTokens();
  running = true;
}

function endGame(){
  running = false;
  resultText.textContent = `ä½ çš„å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;
  resultOverlay.style.display = "flex";
}

function moveLane(delta){
  playerLane = Math.max(0, Math.min(2, playerLane + delta));
  setRunnerLane();
}

function jump(){
  runner.classList.remove("jump");
  void runner.offsetWidth;
  runner.classList.add("jump");
}

function openBank(){
  bankInput.value = questionBank.map(item => `${item.word} | ${item.hint || ""}`.trim()).join("\n");
  bankOverlay.style.display = "flex";
}

function saveBank(){
  const raw = bankInput.value || "";
  const lines = raw.split(/\n+/).map(line => line.trim()).filter(Boolean);
  const items = [];
  lines.forEach(line => {
    const [wordPart, hintPart] = line.split("|").map(part => part.trim());
    if(!wordPart) return;
    items.push({ word: wordPart, hint: hintPart || "" });
  });
  if(items.length < 3){
    alert("è«‹è‡³å°‘è¼¸å…¥ 3 å€‹å–®å­—");
    return;
  }
  questionBank = items;
  bankOverlay.style.display = "none";
  startGame();
}

populateRounds();
setRunnerLane();
updateHud();
spawnTokens();
running = true;

roundSelect.addEventListener("change", (e)=>{
  rounds = parseInt(e.target.value, 10) || 6;
  startGame();
});

speedSelect.addEventListener("change", (e)=>{
  speedFactor = parseFloat(e.target.value) || 1.3;
});

window.addEventListener("resize", ()=>{
  setRunnerLane();
  positionTokens();
});

document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnSpeak").addEventListener("click", ()=>{
  if(currentQuestion) speak(currentQuestion.word);
});

document.getElementById("btnUp").addEventListener("click", ()=> moveLane(-1));
document.getElementById("btnDown").addEventListener("click", ()=> moveLane(1));
document.getElementById("btnJump").addEventListener("click", jump);

document.getElementById("btnBank").addEventListener("click", openBank);
document.getElementById("btnCloseBank").addEventListener("click", ()=>{ bankOverlay.style.display = "none"; });
document.getElementById("btnSaveBank").addEventListener("click", saveBank);

document.getElementById("btnCloseResult").addEventListener("click", ()=>{ resultOverlay.style.display = "none"; });
document.getElementById("btnRestart").addEventListener("click", ()=>{ resultOverlay.style.display = "none"; startGame(); });

document.addEventListener("keydown", (e)=>{
  if(e.key === "ArrowUp"){ moveLane(-1); }
  if(e.key === "ArrowDown"){ moveLane(1); }
  if(e.code === "Space"){ jump(); }
});

gameLoop();
</script>
</body>
</html>
